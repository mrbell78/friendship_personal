BEGIN;

ALTER TABLE patient_interview_master RENAME TO old_patient_interview_master;
CREATE TABLE patient_interview_master
(
    FILE_PATH TEXT,
    PARENT_INTERVIEW_ID NUMERIC DEFAULT (0),
    REF_CENTER_ID NUMERIC,
    DURATION NUMERIC,
    START_TIME NUMERIC,
    DATA_SENT TEXT,
    REF_DATA_ID NUMERIC,
    STATUS TEXT,
    NEXT_FOLLOWUP_DATE NUMERIC,
    PRIORITY NUMERIC,
    UPDATED_ON NUMERIC,
    INTERVIEW_ID INTEGER PRIMARY KEY AUTOINCREMENT,
    BENEF_CODE TEXT REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    USER_ID NUMERIC,
    CREATE_DATE NUMERIC,
    QUESTIONNAIRE_ID NUMERIC,
    FILE_KEY TEXT,
    QUESTION_ANSWER_JSON TEXT
);
DROP TABLE old_patient_interview_master;

ALTER TABLE ccs_treatment RENAME TO old_ccs_treatment;
CREATE TABLE ccs_treatment
(
    CCS_TR_ID INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    BENEF_ID bigint(20) NOT NULL,
    CCS_STATUS_ID int(11) NOT NULL,
    DIAGNOSED_RESULT text,
    DIAGNOSED_DATE NUMERIC DEFAULT 'NULL',
    NEXT_FOLLOWUP_DATE NUMERIC NOT NULL,
    TREATMENT_PROGRESS bit(1) NOT NULL,
    USER_ID int(11),
    BENEF_CODE TEXT NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE
);
INSERT INTO ccs_treatment  SELECT * FROM old_ccs_treatment;
DROP TABLE old_ccs_treatment;

ALTER TABLE immunizable_beneficiary RENAME TO old_immunizable_beneficiary;
CREATE TABLE immunizable_beneficiary
(
    IMMU_BENEF_ID INTEGER,
    BENEF_ID bigint(20) NOT NULL,
    IMMU_TYPE DEFAULT 'NULL',
    AGE_DAY_WHEN_DETECTED int(11) NOT NULL,
    CREATE_DATE NUMERIC NOT NULL DEFAULT '0',
    IMMU_COMPLETE_DATE NUMERIC DEFAULT 'NULL',
    REASON_ID int(11) DEFAULT 'NULL',
    BENEF_CODE VARCHAR(20) NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    UNIQUE (IMMU_TYPE,BENEF_CODE)
);
INSERT INTO immunizable_beneficiary SELECT * FROM old_immunizable_beneficiary;

DROP TABLE old_immunizable_beneficiary;

ALTER TABLE immunization_followup RENAME TO old_immunization_followup;
CREATE TABLE immunization_followup
(
    IMMU_FOLLOWUP_ID INTEGER PRIMARY KEY,
    BENEF_ID bigint(20) NOT NULL,
    CREATE_DATE NUMERIC NOT NULL DEFAULT '0',
    REASON_ID int(3) DEFAULT 'NULL',
    INTERVIEW_ID bigint(20) NOT NULL,
    IMMU_TYPE TEXT,
    FOLLOWUP_TYPE tinyint(1),
    BENEF_CODE VARCHAR(20) NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    FOLLOWUP_DATE NUMERIC,
    UNIQUE (IMMU_TYPE,BENEF_CODE,FOLLOWUP_DATE)
);
INSERT INTO immunization_followup  SELECT * FROM old_immunization_followup;
DROP TABLE old_immunization_followup;

ALTER TABLE immunization_service RENAME TO old_immunization_service;
CREATE TABLE immunization_service
(
    IMMU_SERV_ID INTEGER PRIMARY KEY,
    BENEF_ID bigint(20) DEFAULT 'NULL',
    IMMU_ID int(2),
    IMMU_DATE NUMERIC NOT NULL DEFAULT '0',
    AGE_DAY_WHEN_IMMUNIZED int(11) DEFAULT 'NULL',
    IMMU_TYPE,
    INTERVIEW_ID  NUMERIC ,
    BENEF_CODE VARCHAR(20) NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    UNIQUE (IMMU_ID,BENEF_CODE)
);
INSERT INTO immunization_service  SELECT * FROM old_immunization_service;
DROP TABLE old_immunization_service;



ALTER TABLE immunization_target RENAME TO old_immunization_target;
CREATE TABLE immunization_target
(
    BENEF_ID INTEGER(20) PRIMARY KEY,
    SESSION_DATE NUMERIC,
    EVENT_ID INTEGER(10),
    IMMU_TYPE VARCHAR(10),
    BENEF_CODE VARCHAR(20) REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    UNIQUE (SESSION_DATE,IMMU_TYPE,BENEF_CODE)
);
INSERT INTO immunization_target  SELECT * FROM old_immunization_target;
DROP TABLE old_immunization_target;

ALTER TABLE maternal_info RENAME TO old_maternal_info;
CREATE TABLE maternal_info
(
    MATERNAL_ID INTEGER PRIMARY KEY AUTOINCREMENT DEFAULT (0),
    BENEF_ID NUMERIC DEFAULT (0),
    LMP NUMERIC NOT NULL,
    CALAULATED_LMP NUMERIC,
    EDD NUMERIC,
    HEIGHT_IN_CM NUMERIC,
    PARA NUMERIC DEFAULT 'NULL',
    GRAVIDA NUMERIC DEFAULT 'NULL',
    BMI_VALUE NUMERIC DEFAULT 'NULL',
    BMI VARCHAR(50) DEFAULT 'NULL',
    NO_OF_RISK_ITEM NUMERIC DEFAULT 'NULL',
    REG_INTERVIEW_ID NUMERIC,
    HIGH_RISK_INTERVIEW_ID NUMERIC,
    MATERNAL_STATUS INTEGER(1) NOT NULL DEFAULT (1),
    CREATE_DATE NUMERIC NOT NULL,
    BENEF_CODE VARCHAR(30) NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    UNIQUE (LMP,BENEF_CODE)
);
INSERT INTO maternal_info (MATERNAL_ID,BENEF_ID,LMP,CALAULATED_LMP,EDD,HEIGHT_IN_CM,PARA,GRAVIDA,BMI_VALUE,BMI,NO_OF_RISK_ITEM,REG_INTERVIEW_ID,HIGH_RISK_INTERVIEW_ID,MATERNAL_STATUS,CREATE_DATE,BENEF_CODE)
SELECT MATERNAL_ID,BENEF_ID,LMP,LMP,EDD,HEIGHT_IN_CM,PARA,GRAVIDA,BMI_VALUE,BMI,NO_OF_RISK_ITEM,REG_INTERVIEW_ID,HIGH_RISK_INTERVIEW_ID,MATERNAL_STATUS,CREATE_DATE,BENEF_CODE FROM old_maternal_info;

DROP TABLE old_maternal_info;


ALTER TABLE maternal_abortion RENAME TO old_maternal_abortion;
CREATE TABLE maternal_abortion
(
    ABORT_ID NUMERIC DEFAULT (0),
    BENEF_ID NUMERIC,
    MATERNAL_ID NUMERIC REFERENCES maternal_info(MATERNAL_ID) ON UPDATE CASCADE ON DELETE CASCADE,
    ABORT_DATE NUMERIC NOT NULL,
    PREGNANCY_WEEK NUMERIC,
    UNUSUAL_OUTCOME_TYPE VARCHAR(50),
    ABORT_PLACE_ID NUMERIC,
    ABORT_BY_ID NUMERIC,
    INTERVIEW_ID NUMERIC,
    BENEF_CODE VARCHAR(20) NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    UNIQUE (ABORT_DATE,BENEF_CODE)
);
INSERT INTO maternal_abortion  SELECT * FROM old_maternal_abortion;
DROP TABLE old_maternal_abortion;


ALTER TABLE maternal_baby_info RENAME TO old_maternal_baby_info;
CREATE TABLE maternal_baby_info
(
    MATERNAL_BABY_ID INTEGER(20),
    MATERNAL_ID INTEGER(20) DEFAULT 'NULL' REFERENCES maternal_info(MATERNAL_ID) ON UPDATE CASCADE ON DELETE CASCADE,
    GENDER VARCHAR(5) DEFAULT 'NULL',
    BABY_STATE VARCHAR(20),
    CHILD_BENEF_CODE VARCHAR(20),
    BENEF_CODE VARCHAR(20) REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    LMP NUMERIC,
    UNIQUE (CHILD_BENEF_CODE,LMP)
);
INSERT INTO maternal_baby_info  SELECT * FROM old_maternal_baby_info;
DROP TABLE old_maternal_baby_info;


ALTER TABLE maternal_delivery RENAME TO old_maternal_delivery;
CREATE TABLE maternal_delivery
(
    MATERNAL_DELIVERY_ID INTEGER(20) DEFAULT (0),
    MATERNAL_ID INTEGER(20) REFERENCES maternal_info(MATERNAL_ID) ON UPDATE CASCADE ON DELETE CASCADE,
    MOTHER_CONDITION VARCHAR(50),
    DELIVERY_DATE NUMERIC(20),
    DELIVERY_TIME VARCHAR(20),
    DELIVERY_PLACE VARCHAR(100),
    DELIVERED_BY_CSBA VARCHAR(20),
    DELIVERY_TYPE VARCHAR(100),
    PERSON_DELIVERED VARCHAR(100),
    NO_OF_BABY INT,
    DELIVERY_CARE_INTERVIEW_ID INTEGER(20),
    BENEF_CODE VARCHAR(20) REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    LMP NUMERIC(20),
    UNIQUE (BENEF_CODE,LMP) ON CONFLICT REPLACE
);
INSERT INTO maternal_delivery  SELECT * FROM old_maternal_delivery;
DROP TABLE old_maternal_delivery;

ALTER TABLE maternal_service RENAME TO old_maternal_service;
CREATE TABLE maternal_service
(
    MATERNAL_SERVICE_ID INTEGER DEFAULT (0),
    MATERNAL_ID INTEGER NOT NULL REFERENCES maternal_info(MATERNAL_ID) ON UPDATE CASCADE ON DELETE CASCADE,
    BMI_VALUE NUMERIC,
    BMI NUMERIC,
    PULSE NUMERIC DEFAULT 'NULL',
    BLOOD_PRESSURE VARCHAR(10) DEFAULT 'NULL',
    BLOOD_PRESSURE_TYPE VARCHAR(50) DEFAULT 'NULL',
    TEMPERATURE NUMERIC DEFAULT 'NULL',
    WEIGHT NUMERIC DEFAULT 'NULL',
    HEIGHT_IN_CM NUMERIC DEFAULT 'NULL',
    WEEKLY_WEIGHT_GAIN NUMERIC DEFAULT 'NULL',
    ANAEMIA VARCHAR(50) DEFAULT 'NULL',
    JAUNDICE VARCHAR(50) DEFAULT 'NULL',
    OEDEMA VARCHAR(50) DEFAULT 'NULL',
    VOMITING VARCHAR(50) DEFAULT 'NULL',
    SUGAR_OF_URINE VARCHAR(50) DEFAULT 'NULL',
    PROTEIN_OF_URINE VARCHAR(20) DEFAULT 'NULL',
    HEIGHT_OF_UTERUS VARCHAR(50) DEFAULT 'NULL',
    FETAL_MOVEMENT VARCHAR(50) DEFAULT 'NULL',
    FETAL_HEART_RATE VARCHAR(50),
    FETAL_LIE VARCHAR(20) DEFAULT 'NULL',
    FETAL_PRESENTATION VARCHAR(20) DEFAULT 'NULL',
    BREAST_PROBLEM VARCHAR(150) DEFAULT 'NULL',
    VITAMIN_A VARCHAR(3) DEFAULT 'NULL',
    RISK_STATE VARCHAR(15) DEFAULT 'NULL',
    RISK_PROP NUMERIC,
    MATERENAL_STATUS VARCHAR(10) DEFAULT 'NULL',
    MATERNAL_CARE_ID NUMERIC NOT NULL,
    INTERVIEW_ID NUMERIC,
    CREATE_DATE NUMERIC NOT NULL,
    USER_ID NUMERIC,
    BENEF_ID NUMERIC,
    BENEF_CODE VARCHAR(30) NOT NULL REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    LMP NUMERIC NOT NULL,
    UNIQUE (MATERNAL_CARE_ID,BENEF_CODE,LMP)
);
INSERT INTO maternal_service  SELECT * FROM old_maternal_service;
DROP TABLE old_maternal_service;

ALTER TABLE prescription_detail RENAME TO old_prescription_detail;
CREATE TABLE prescription_detail
(
    PRESC_DTL_ID INTEGER PRIMARY KEY,
    PRESC_ID NUMERIC,
    MEDICINE_ID NUMERIC,
    QTY VARCHAR,
    TAKING_RULE TEXT,
    REMARKS TEXT,
    DURATION_DAY VARCHAR
);

INSERT INTO prescription_detail  SELECT * FROM old_prescription_detail;
DROP TABLE old_prescription_detail;


ALTER TABLE medicine_consumption_master RENAME TO old_medicine_consumption_master;
CREATE TABLE medicine_consumption_master
(
    INTERVIEW_ID NUMERIC,
    BENEF_CODE TEXT REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    MED_CONSUMP_ID INTEGER PRIMARY KEY,
    CONSUMP_DATE NUMERIC,
    LOCATION_ID NUMERIC,
    USER_ID TEXT,
    TOTAL_PRICE NUMERIC,
    REMARKS TEXT,
    DATA_SENT TEXT DEFAULT ('N')
);
INSERT INTO medicine_consumption_master  SELECT * FROM old_medicine_consumption_master;
DROP TABLE old_medicine_consumption_master;

ALTER TABLE user_schedule RENAME TO old_user_schedule;
CREATE TABLE user_schedule
(
    BENEF_CODE TEXT REFERENCES beneficiary(BENEF_CODE) ON UPDATE CASCADE ON DELETE CASCADE,
    INTERVIEW_ID NUMERIC DEFAULT (0),
    SCHED_ID INTEGER PRIMARY KEY,
    SCHED_DESC TEXT,
    CREATE_DATE NUMERIC,
    SCHED_DATE NUMERIC,
    SCHED_STATUS NUMERIC,
    TYPE TEXT,
    BENEF_ID NUMERIC,
    ATTENDED_DATE NUMERIC,
    EVENT_ID NUMERIC,
    USER_ID NUMERIC,
    DATA_SENT TEXT DEFAULT ('N'),
    LANG TEXT,
    SYSTEM_CHANGED_DATE NUMERIC DEFAULT (0),
    REFERENCE_ID INTEGER(11)
);

INSERT INTO user_schedule  SELECT * FROM old_user_schedule;
DROP TABLE old_user_schedule;


CREATE TABLE patient_interview_detail ( 
    INTERVIEW_DTL_ID INTEGER,
    INTERVIEW_ID     INTEGER,
    Q_ID             INTEGER,
    ANSWER           TEXT,
    UNIQUE ( INTERVIEW_ID, Q_ID ) 
);

CREATE TABLE questionnaire_detail ( 
    Q_ID             INTEGER         NOT NULL,
    QUESTIONNAIRE_ID INTEGER         NOT NULL,
    QUESTION_ID      INTEGER         NOT NULL,
    Q_NAME           VARCHAR( 150 )  NOT NULL,
    CREATE_DATE      INTEGER,
    LAST_UPDATED_ON  INTEGER         DEFAULT 'NULL',
    LAST_UPDATED_BY  INTEGER,
    Q_STATUS         INTEGER         NOT NULL,
    Q_JSON           TEXT,
    Q_TYPE           VARCHAR( 50 )   DEFAULT 'NULL',
    LAST_LANG_SRC_ID INTEGER,
    UNIQUE ( QUESTIONNAIRE_ID, QUESTION_ID ) 
);
UPDATE data_version set CURRENT_VERSION=0 WHERE TABLE_NAME='questionnaire';

COMMIT;

